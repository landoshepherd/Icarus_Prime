name: Build STM32 Firmware

on:
  push:
    branches: [ "main"]
  pull_request:
    branches: [ "main" ]

jobs:
  build-firmware:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Build Docker Image
      run: docker build -t stm32-builder .

    - name: Run Build Script in Docker Container
      run: |
        # Mount the current directory into the container's /project directory
        # and run the build script.
        # Run via bash to avoid permission issues if the script does not have the executable bit set
        docker run --rm -v "${{ github.workspace }}:/project" stm32-builder bash /project/ci/build.sh

    - name: Upload Firmware Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: firmware-binaries
        # Upload any firmware built under the project's build output directory.
        # The CMake build places artifacts under icarus_prime/Debug/bin by default.
        path: |
          icarus_prime/Debug/bin/*.elf
          icarus_prime/Debug/bin/*.bin
          icarus_prime/Debug/bin/*.hex
        if-no-files-found: error # Fail the workflow if the build produced no output